drop table TEMP_CTJ_AIR_EXCHANGE_ALL
go
CREATE TABLE TEMP_CTJ_AIR_EXCHANGE_ALL NOLOGGING PARALLEL 32 AS
select TO_CHAR(T.INSERTED_AT,'YYYY-MM-DD')INSERTED_AT,
  sum( case substr(EXTERNAL_CODE,1,2) when 'DT' then VIRTUAL_CURRENCY_AMOUNT else 0 end) DT_AMOUNT,
  sum( case substr(EXTERNAL_CODE,1,2) when 'SP' then VIRTUAL_CURRENCY_AMOUNT else 0 end) SP_AMOUNT,
  count(case substr(EXTERNAL_CODE,1,2) when 'SP' then 1 else NULL end) as SP_COUNT,
   count(case substr(EXTERNAL_CODE,1,2) when 'DT' then 1 else NULL end) as DT_COUNT
  from BI_AIR_REDEEM_SEGMENT T 
where	T.INSERTED_AT >=  To_Date('2018-09-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
and T.INSERTED_AT < To_Date('2018-10-10 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
AND T.EVENT_ID NOT IN (
SELECT E.CANCELLED_EVENT_ID FROM BI_REV_TRANSACTION E )
AND T.EVENT_CLASS='AAT'
AND T.STATUS=0
GROUP BY TO_CHAR(T.INSERTED_AT,'YYYY-MM-DD')order by INSERTED_AT asc
GO
ALTER TABLE TEMP_CTJ_AIR_EXCHANGE_ALL NOPARALLEL
go
select * from TEMP_CTJ_AIR_EXCHANGE_ALL




---well done
CREATE TABLE TEMP_CTJ_AIR_EXCHANGE_ALL NOLOGGING PARALLEL 32 AS
select T.INSERTED_AT,
  sum( case substr(T.EXTERNAL_CODE,1,2) when 'DT' then t.DT_AMOUNT else 0 end) DT_AMOUNT,
  sum( case substr(T.EXTERNAL_CODE,1,2) when 'SP' then t.SP_AMOUNT else 0 end) SP_AMOUNT,
  count(  case substr(T.EXTERNAL_CODE,1,2) when 'SP' then SP_COUNT else NULL end) as SP_COUNT,
   count(  case substr(T.EXTERNAL_CODE,1,2) when 'DT' then DT_COUNT else NULL end) as DT_COUNT,
   COUNT(DISTINCT T.EXTERNAL_CODE) ALL_EXTERNAL_CODE_COUNT
  from ( SELECT EXTERNAL_CODE,TO_CHAR(A.INSERTED_AT,'YYYY-MM-DD')INSERTED_AT,
  sum( case substr(A.EXTERNAL_CODE,1,2) when 'DT' then A.VIRTUAL_CURRENCY_AMOUNT else 0 end) DT_AMOUNT,
  sum( case substr(A.EXTERNAL_CODE,1,2) when 'SP' then A.VIRTUAL_CURRENCY_AMOUNT else 0 end) SP_AMOUNT,
 count(  DISTINCT case substr(A.EXTERNAL_CODE,1,2) when 'SP' then 1 else NULL end) as SP_COUNT,
   count(  DISTINCT case substr(A.EXTERNAL_CODE,1,2) when 'DT' then 1 else NULL end) as DT_COUNT
 FROM BI_AIR_REDEEM_SEGMENT A
where	A.INSERTED_AT >=  To_Date('2018-09-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
and A.INSERTED_AT < To_Date('2018-10-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS')
AND A.EVENT_ID NOT IN (
SELECT E.CANCELLED_EVENT_ID FROM BI_REV_TRANSACTION E )
AND A.EVENT_CLASS='AAT'
AND A.STATUS=0
AND A.CHANNEL IN('B2CM','B2C') AND EXTERNAL_CODE='SP11161339'
GROUP BY A.EXTERNAL_CODE,TO_CHAR(A.INSERTED_AT,'YYYY-MM-DD')
 )T
GROUP BY T.INSERTED_AT order by T.INSERTED_AT asc
GO
ALTER TABLE TEMP_CTJ_AIR_EXCHANGE_ALL NOPARALLEL
go
select * from TEMP_CTJ_AIR_EXCHANGE_ALL